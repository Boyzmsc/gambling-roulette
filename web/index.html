<!DOCTYPE html>
<html lang="en">

<head>
    <title>Gambling Roulette</title>
    <link rel="stylesheet" href="main.css">

    <script src='web3.min.js'></script>
    <script type="text/javascript" src="abilist.js"></script>
    <script defer type="text/javascript">
        let accounts = null;
        let gambleInstance = null;
        let resultBox = null;
        let rouletteList = null;

        window.addEventListener('load', gamble);

        /// Gamble Init
        async function gamble() {
            if (window.ethereum) {
                resultBox = document.getElementById("resultbox");

                let accountBtn = document.getElementById("accountBtn");
                accountBtn.addEventListener('click', accountBtnClicked);
            } else if (window.web3) {
                // Dapp 지원 브라우저일 경우
                window.web3 = new Web3(web3.currentProvider);
            }
            else {
                // Dapp 지원 브라우저 아닐 경우
                window.web3 = null
            }
        }

        /// Account 연결
        async function accountBtnClicked() {
            // account 가져오기 (= Metamask 계정)
            accounts = await ethereum.request({ method: 'eth_requestAccounts' });

            this.disabled = true;

            const showAccount = document.getElementById("showAccount");
            showAccount.innerHTML = accounts[0];

            resultBox.innerHTML = "Account Connected"
            getGambleInstance();
        }

        /// Gamble 인스턴스 생성
        async function getGambleInstance() {
            // Deploy를 수행한 address (= Metamask 계정 아님)
            // Gamble의 address
            let address = "0xf8e81D47203A594245E36C48e151709F0C19fBe8";

            window.web3 = new Web3(window.ethereum);

            // Gamble의 Contract 생성
            gambleInstance = await new window.web3.eth.Contract(gambleAbi, address);
            crawlingData();
            registerEventHandlers();
        }

        /// Contract 데이터 가져오기
        async function crawlingData() {
            let totalBet = document.getElementById("totalBet");
            totalBet.innerText = await gambleInstance.methods.totalBet().call();
            let requireBet = document.getElementById("requireBet");
            requireBet.innerText = await gambleInstance.methods.requireBet().call();

            let baseBet = document.getElementById("baseBet");
            baseBet.innerText = await gambleInstance.methods.baseBet().call();
            let increaseRate = document.getElementById("increaseRate");
            increaseRate.innerText = await gambleInstance.methods.increaseRate().call();

            let betAmt = document.getElementById("betAmt");
            betAmt.value = 0;

            rouletteList = [
                "현재 참여자에게 베팅금 전액 송금",
                "특정 참여자에게 베팅금 전액 송금",
                "베팅금 증가 비율 1% 증가",
                "베팅금 증가 비율 2% 증가",
                "베팅금 증가 비율 5% 증가",
                "PASS"
            ];
        }

        /// Dom 객체와 동작 함수 연결
        async function registerEventHandlers() {
            let mainBtn = document.getElementById("mainBtn");
            mainBtn.addEventListener('click', launchMain);
            let percentageBtn = document.getElementById("percentageBtn");
            percentageBtn.addEventListener('click', checkPercentage);

            let subBtn = document.getElementById("subBtn");
            subBtn.addEventListener('click', launchSub);
            let partiBtn = document.getElementById("partiBtn");
            partiBtn.addEventListener('click', checkParti);

            let betBtn = document.getElementById("betBtn");
            betBtn.addEventListener('click', bet);
        }

        /// 메인 룰렛 작동
        async function launchMain() {
            if (gambleInstance != null) {
                // 난수 생성 (1 <= rNum <= 100)
                let rNum = Math.floor(Math.random() * 100) + 1;
                console.log(rNum);

                // 메인 룰렛 돌리기
                //

                let goToSub = false;
                if (rNum > 95) {
                    // 현재 참여자에게 베팅금 전액 송금 당첨 시 (100~96 / 5%)
                    let value = await gambleInstance.methods.sendBetToSomeone(accounts[0]).call();
                    resultbox.innerHTML = value;
                } else if (rNum > 90) {
                    // 특정 참여자에게 베팅금 전액 송금 당첨 시 (95~91 / 5%)
                    // 메인 룰렛 버튼 비활성화 및 서브 룰렛 버튼 활성화
                    this.disabled = true;
                    let subBtn = document.getElementById("subBtn");
                    subBtn.disabled = false;
                    goToSub = true;
                } else if (rNum > 85) {
                    // 베팅금 증가 비율 1% 증가 당첨 시 (90~86 / 5%)
                    let value = await gambleInstance.methods.changeRate(1).call();
                    resultbox.innerHTML = value;
                } else if (rNum > 80) {
                    // 베팅금 증가 비율 2% 증가 당첨 시 (85~81 / 5%)
                    let value = await gambleInstance.methods.changeRate(2).call();
                    resultbox.innerHTML = value;
                } else if (rNum > 75) {
                    // 베팅금 증가 비율 5% 증가 당첨 시 (80~76 / 5%)
                    let value = await gambleInstance.methods.changeRate(5).call();
                    resultbox.innerHTML = value;
                } else {
                    // PASS (75~1 / 75%)
                    resultbox.innerHTML = "PASS";
                }

                if (!goToSub) {
                    // 메인 룰렛 버튼 비활성화 및 베팅 버튼 활성화
                    this.disabled = true;
                    let betBtn = document.getElementById("betBtn");
                    betBtn.disabled = false;

                    // 갱신된 정보 가져오기
                    crawlingData();
                }
            }
        }

        /// 서브 룰렛 작동
        async function launchSub() {
            if (gambleInstance != null) {
                // 참여자 정보 리스트에 저장
                // let cntParti = await gambleInstance.methods.numParticipants().call();
                // let partiList = [];
                // for (let i = 0; i < cntParti; i++) {
                //     let p = await gambleInstance.methods.participants(i).call();
                //     console.log(p);
                //     partiList.push(p);
                // }

                // 난수 생성 (0 <= rNum < 참여자 수)
                let rNum = Math.floor(Math.random() * cntParti);

                // 서브 룰렛 돌리기
                //

                let value = await gambleInstance.methods.sendBetToSomeone(partiList[rNum].addr).call();
                resultbox.innerHTML = value;

                // 서브 룰렛 버튼 비활성화 및 베팅 버튼 활성화
                this.disabled = true;
                let betBtn = document.getElementById("betBtn");
                betBtn.disabled = false;

                // 갱신된 정보 가져오기
                crawlingData();
            }
        }

        /// 베팅
        async function bet() {
            if (gambleInstance != null) {
                try {
                    let requireBet = await gambleInstance.methods.requireBet().call();
                    let val = document.getElementById("betAmt").value;

                    if (val >= requireBet) {
                        // 입력한 금액이 최소 필요 금액 이상일 경우
                        let body = document.querySelector('body');
                        let check = document.querySelector('.check');
                        let yesBtn = document.getElementById('yesBtn');
                        let cancelBtn = document.getElementById('cancelBtn');

                        check.style.display = "block";
                        body.style.overflow = 'hidden';
                        resultbox.innerHTML = "Betting Continuing...";

                        // 취소 버튼 클릭 시
                        cancelBtn.addEventListener('click', () => {
                            check.style.display = "none";
                            body.style.overflow = 'auto';
                            resultbox.innerHTML = "Betting Canceled";
                        });

                        // 승인 버튼 클릭 시
                        yesBtn.addEventListener('click', async () => {
                            check.style.display = "none";
                            body.style.overflow = 'auto';

                            console.log("send");

                            // 입력한 금액 베팅
                            let value = await gambleInstance.methods.bet().send({ from: accounts[0], value: val });
                            resultbox.innerHTML = value;

                            // 베팅 버튼 비활성화 및 메인 룰렛 버튼 활성화
                            this.disabled = true;
                            let mainBtn = document.getElementById("mainBtn");
                            mainBtn.disabled = false;
                        });
                    } else {
                        resultbox.innerHTML = "Enter more than Requirement";
                    }
                } catch (error) {
                    resultBox.innerHTML = "Error Occured";
                    console.log(error);
                }
            }
        }

        /// 참여자들 정보 확인
        async function checkParti() {
            if (gambleInstance != null) {
                // 참여자 정보 리스트 모달로 출력
                document.querySelector(".modalTitle").innerHTML = "Participants";

                // 참여자 정보 리스트에 저장
                // let cntParti = await gambleInstance.methods.numParticipants().call();
                // let partiList = [];
                // for (let i = 0; i < cntParti; i++) {
                //     let p = await gambleInstance.methods.participants(i).call();
                //     console.log(p);
                //     partiList.push(p);
                // }

                // Temp
                let cntTmp = 3;
                let tmpList = [
                    { addr: "0xc237ba510b441da4847155481146b86d17cae8ca", amount: 1000 },
                    { addr: "0xa8s4d5c6v8d1vx2cv47155481146b86d17cae8ca", amount: 2000 },
                    { addr: "0xt8sd5f6x8c41v28h647155481146b86d17cae8ca", amount: 5500 },
                ];

                let txt = "";
                for (let i = 0; i < cntTmp; i++) {
                    txt += "<tr><td class='tg-sej6'>" + tmpList[i].addr.substr(0, 27) + "...</td><td class='tg-sej6'>" + tmpList[i].amount + "</td></tr>";
                }
                document.querySelector(".modalBody").innerHTML = "<table class='tg'><thead><tr><th id='tg1' class='tg-9gjn'>참여자</th><th id='tg2' class='tg-9gjn'>베팅금</th></tr ></thead ><tbody>" + txt + "</tbody></table >";

                let body = document.querySelector('body');
                let modal = document.querySelector('.modal');
                let closeBtn = document.getElementById('closeBtn');

                modal.style.display = "block";
                body.style.overflow = 'hidden';

                closeBtn.addEventListener('click', () => {
                    modal.style.display = "none";
                    body.style.overflow = 'auto';
                });
            }
        }

        /// 룰렛 확률 정보 확인
        async function checkPercentage() {
            if (gambleInstance != null) {
                document.querySelector(".modalTitle").innerHTML = "Roulette's Percentage";
                document.querySelector(".modalBody").innerHTML = "<table class='tg'><thead><tr><th id='tg1' class='tg-9gjn'>내용</th><th id='tg2' class='tg-9gjn'>확률</th></tr ></thead ><tbody><tr><td class='tg-sej6'>현재 참여자에게 베팅금 전액 송금</td><td class='tg-sej6'>5%</td></tr><tr><td class='tg-sej6'>특정 참여자에게 베팅금 전액 송금</td><td class='tg-sej6'>5%</td></tr><tr><td class='tg-sej6'>베팅금 증가 비율 1% 증가</td><td class='tg-sej6'>5%</td></tr><tr><td class='tg-sej6'>베팅금 증가 비율 2% 증가</td><td class='tg-sej6'>5%</td></tr><tr><td class='tg-sej6'>베팅금 증가 비율 5% 증가</td><td class='tg-sej6'>5%</td></tr><tr><td class='tg-sej6'>PASS</td><td class='tg-sej6'>75%</td></tr></tbody></table >";

                // 룰렛 확률 정보 리스트 모달로 출력
                let body = document.querySelector('body');
                let modal = document.querySelector('.modal');
                let closeBtn = document.getElementById('closeBtn');

                modal.style.display = "block";
                body.style.overflow = 'hidden';

                closeBtn.addEventListener('click', () => {
                    modal.style.display = "none";
                    body.style.overflow = 'auto';
                });
            }
        }

        /// 변수 값 표시
        async function showValue() {
            if (gambleInstance != null) {
                try {
                    let value = await gambleInstance.methods[this.id]().call();
                    console.log(value);
                    this.innerHTML = value;
                } catch (error) {
                    this.innerHTML = "Error Occured";
                    console.log(error);
                }
            }
        }
    </script>
</head>

<body>
    <div class="middle">
        <!-- Header -->
        <div class="mainTitle">GAMBLING</div>
        <div class="subTitle">Roulette Game&nbsp;<input class="btn join" type="button" id="accountBtn" value="JOIN">
        </div>
        <hr />

        <!-- Contract Info -->
        <div class="totalBetContainer">◦Total :&nbsp;<span id="totalBet">0</span>&nbsp;wei</div>
        <div class="requireBetContainer">◦Requirement :&nbsp;<span id="requireBet">0</span>&nbsp;(=&nbsp;<span
                id="baseBet">0</span>&nbsp;/&nbsp;<span id="increaseRate">0</span>%)&nbsp;wei</div>
        <br />

        <!-- Main Roulette -->
        <div id="mainRoulette" class="mainRoulette">Main Roulette</div>
        <div class="mainRBtnContainer"><input class="btn" type="button" id="mainBtn" value="LAUNCH"
                disabled>&nbsp;<input class="btn" type="button" id="percentageBtn" value="PERCENTAGE"></div>
        <br />

        <!-- Sub Roulette -->
        <div id="subRoulette" class="subRoulette">Sub Roulette</div>
        <div class="subRBtnContainer"><input class="btn" type="button" id="subBtn" value="LAUNCH" disabled>&nbsp;<input
                class="btn" type="button" id="partiBtn" value="PARTICIPANTS"></div>
        <br />

        <!-- Betting Section -->
        <div class="accountContainer">◦Account :&nbsp;<span id="showAccount">Empty</span></div>
        <div class="betContainer">◦Betting :&nbsp;<input type="number" value="0" step="100" min="0"
                id="betAmt">&nbsp;wei&nbsp;<input class="btn submit" type="submit" id="betBtn" value="BET"></div>
        <hr />

        <!-- Modal -->
        <div class="modal">
            <div class="modalContainer">
                <div class="modalTitle"></div>
                <div class="modalBody"></div>
                <div class="modalBtn">
                    <input class="btn" type="button" id="closeBtn" value="CLOSE">
                </div>
            </div>
        </div>

        <!-- Modal -->
        <div class="check">
            <div class="checkContainer">
                <div class="checkTitle">Check</div>
                <div class="checkBody">Are You Sure?</div>
                <div class="checkBtn">
                    <input class="btn" type="button" id="yesBtn" value="SURE">
                    <input class="btn" type="button" id="cancelBtn" value="CANCLE">
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="resultContainer">◦Result :&nbsp;<span id="resultbox">Empty</span></div>
    </div>
</body>

</html>